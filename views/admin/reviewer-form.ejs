<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thinky - <%= reviewer ? 'Edit Reviewer' : 'Add Reviewer' %> - Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/style.css">
  
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  
  <!-- Highlight.js for code syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  
  <!-- Quill Better Table CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.css">
  
  <style>
    .ql-container {
      min-height: 400px;
      font-size: 1rem;
      border-radius: 0 0 10px 10px;
    }
    .ql-toolbar {
      border-radius: 10px 10px 0 0;
      background: var(--light-pink);
    }
    .ql-editor {
      min-height: 400px;
    }
    .ql-snow .ql-stroke {
      stroke: var(--dark-pink);
    }
    .ql-snow .ql-fill {
      fill: var(--dark-pink);
    }
    .ql-snow .ql-picker-label {
      color: var(--dark-pink);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="bi bi-book-fill me-2"></i>Thinky
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="bi bi-house-fill me-1"></i>Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/dashboard">
              <i class="bi bi-speedometer2 me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/admin/logout">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4 mb-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/dashboard" style="color: var(--dark-pink);">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="/admin/subject/<%= subject.id %>/reviewers" style="color: var(--dark-pink);"><%= subject.name %></a></li>
        <li class="breadcrumb-item active" aria-current="page">
          <%= reviewer ? 'Edit Reviewer' : 'Add Reviewer' %>
        </li>
      </ol>
    </nav>

    <!-- Form Card -->
    <div class="card">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="bi bi-<%= reviewer ? 'pencil-square' : 'plus-circle' %> me-2"></i>
          <%= reviewer ? 'Edit Reviewer' : 'Add New Reviewer' %> - <%= subject.name %>
        </h4>
      </div>
      <div class="card-body">
        <form method="POST" action="<%= reviewer ? '/admin/reviewer/' + reviewer.id + '/edit' : '/admin/subject/' + subject.id + '/reviewer/add' %>" id="reviewerForm">
          <div class="mb-3">
            <label for="title" class="form-label">
              <i class="bi bi-bookmark-fill me-2"></i>Reviewer Title
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="title" 
              name="title" 
              required
              placeholder="e.g., Chapter 1: Introduction to Algebra"
              value="<%= reviewer ? reviewer.title : '' %>"
              autofocus
            >
            <small class="text-muted">Give your reviewer a descriptive title</small>
          </div>

          <div class="mb-3">
            <label class="form-label">
              <i class="bi bi-text-paragraph me-2"></i>Content
            </label>
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Formatting Tips:</strong> Use the toolbar to format text, add headings, lists, code blocks, and more!
            </div>
            
            <!-- Quill Editor -->
            <div id="editor" style="background: white;"></div>
            
            <!-- Hidden input to store content -->
            <input type="hidden" name="content" id="content">
            <!-- Hidden input to store quiz JSON (managed by the Quiz Builder below) -->
            <input type="hidden" name="quiz" id="quiz">
          </div>

          <!-- Quiz Builder -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Quiz Builder</h5>
            </div>
            <div class="card-body">
              <p class="text-muted">Create a quiz for this reviewer. Add questions, choose a type, provide choices for multiple choice, and configure quiz settings.</p>

              <div id="quizBuilder" class="mb-3"></div>

              <div class="d-flex gap-2">
                <button id="btnAddQuestion" type="button" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-plus-circle me-1"></i>Add Question
                </button>
                <button id="btnClearQuiz" type="button" class="btn btn-outline-danger btn-sm">
                  <i class="bi bi-trash me-1"></i>Clear Quiz
                </button>
              </div>

              <hr>

              <h6>Settings</h6>
              <div class="row g-2 align-items-center">
                <div class="col-auto">
                  <label for="quizTimeLimit" class="form-label">Time Limit (minutes)</label>
                  <input type="number" min="0" class="form-control form-control-sm" id="quizTimeLimit" placeholder="0 for no limit">
                </div>
                <div class="col-auto d-flex align-items-end">
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="quizShuffle">
                    <label class="form-check-label" for="quizShuffle">Scramble Questions</label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-success">
              <i class="bi bi-<%= reviewer ? 'check-circle-fill' : 'plus-circle-fill' %> me-2"></i>
              <%= reviewer ? 'Update Reviewer' : 'Create Reviewer' %>
            </button>
            <a href="/admin/subject/<%= subject.id %>/reviewers" class="btn btn-secondary">
              <i class="bi bi-x-circle me-2"></i>Cancel
            </a>
          </div>
        </form>
      </div>
    </div>

    <!-- Preview Card -->
    <div class="card mt-4">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-eye-fill me-2"></i>Live Preview
        </h5>
      </div>
      <div class="card-body">
        <div id="preview" class="content-display">
          <p class="text-muted">Start typing to see the preview...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer mt-5">
    <div class="container">
      <p>&copy; <%= new Date().getFullYear() %> Thinky. All rights reserved.</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Highlight.js (required by Quill for syntax highlighting) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  
  <!-- Quill JS -->
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <!-- Quill Better Table JS (after Quill) -->
  <script src="https://cdn.jsdelivr.net/npm/quill-better-table@1.2.8/dist/quill-better-table.min.js"></script>
  
  <% if (reviewer && reviewer.content) { %>
    <script id="existingContent" type="application/json"><%- JSON.stringify(reviewer.content) %></script>
  <% } %>

  <% if (reviewer && reviewer.quiz) { %>
    <script id="existingQuiz" type="application/json"><%- JSON.stringify(reviewer.quiz) %></script>
  <% } %>

  <script>
    // Register better-table module if present
    if (window.Quill && window.QuillBetterTable) {
      Quill.register({ 'modules/better-table': window.QuillBetterTable }, true);
    }

    // Initialize Quill editor
    var toolbarOptions = [
      [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
      [{ 'font': [] }],
      [{ 'size': ['small', false, 'large', 'huge'] }],
      ['bold', 'italic', 'underline', 'strike'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'script': 'sub'}, { 'script': 'super' }],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      [{ 'indent': '-1'}, { 'indent': '+1' }],
      [{ 'align': [] }],
      ['blockquote', 'code-block'],
      ['link', 'image'],
      ['clean']
    ];

    var quillModules = { toolbar: toolbarOptions, syntax: true };

    // If better-table module has been registered, include it in modules config
    if (Quill && Quill.imports && Quill.imports['modules/better-table']) {
      quillModules['better-table'] = {
        operationMenu: {
          items: {
            insertRow: { text: 'Insert row' },
            insertColumn: { text: 'Insert column' },
            deleteRow: { text: 'Delete row' },
            deleteColumn: { text: 'Delete column' },
            deleteTable: { text: 'Delete table' }
          }
        }
      };
    }

    var quill = new Quill('#editor', {
      theme: 'snow',
      modules: quillModules,
      placeholder: 'Start writing your reviewer content here...'
    });

     /* Make toolbar sticky and editor scrollable so toolbar stays visible
       when editing long content. The container (.ql-container) holds the
       toolbar and editor; we give it a max-height and allow the editor
       to scroll internally while keeping the toolbar fixed inside the container. */
    (function makeQuillToolbarSticky() {
      // Slight delay to allow Quill to build DOM
      setTimeout(function() {
        var container = document.querySelector('#editor').closest('.ql-container');
        if (!container) {
          // If Quill uses different structure, target parent
          container = document.querySelector('.ql-container');
        }
        if (container) {
          container.style.maxHeight = '560px';
          container.style.overflow = 'hidden';
          var toolbar = container.querySelector('.ql-toolbar');
          var editor = container.querySelector('.ql-editor');
          if (toolbar) {
            toolbar.style.position = 'sticky';
            toolbar.style.top = '0';
            toolbar.style.zIndex = '20';
            toolbar.style.background = 'var(--light-pink)';
          }
          if (editor) {
            editor.style.maxHeight = '500px';
            editor.style.overflowY = 'auto';
            editor.style.padding = '1rem';
          }
        }
      }, 50);
    })();

    // If better-table module is available, register handler and add a toolbar button
    setTimeout(function() {
      try {
        // Try to find the better-table export under common global names
        var BetterTableExport = window.QuillBetterTable || window.QuillBetterTableModule || window['quill-better-table'] || window['QuillBetterTable'];
        if (BetterTableExport && !Quill.imports['modules/better-table']) {
          // Some builds export a default property
          var moduleToRegister = BetterTableExport.default || BetterTableExport;
          Quill.register({ 'modules/better-table': moduleToRegister }, true);
        }

        var betterTableModule = null;
        try { betterTableModule = quill.getModule('better-table'); } catch(e) { betterTableModule = null; }

        var toolbarModule = quill.getModule('toolbar');
        if (toolbarModule) {
          // Create button element and append to first .ql-formats group
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'ql-insertTable btn btn-sm';
          btn.title = 'Insert Table';
          btn.innerHTML = '<i class="bi bi-table"></i>';

          var formats = toolbarModule.container.querySelectorAll('.ql-formats');
          if (formats && formats.length) {
            formats[0].appendChild(btn);
          } else {
            toolbarModule.container.appendChild(btn);
          }

          // Fallback: Insert a simple HTML table directly if better-table module isn't available
          btn.addEventListener('click', function() {
            try {
              var sel = quill.getSelection(true);
              var index = (sel && typeof sel.index === 'number') ? sel.index : quill.getLength();
              var tableHtml = '<table class="ql-table" style="border-collapse: collapse; width: 100%;">';
              for (var r = 0; r < 3; r++) {
                tableHtml += '<tr>';
                for (var c = 0; c < 3; c++) {
                  tableHtml += '<td style="border:1px solid #ddd; padding:8px;">&nbsp;</td>';
                }
                tableHtml += '</tr>';
              }
              tableHtml += '</table><p></p>';

              // If better-table is available, use it; otherwise paste HTML
              if (betterTableModule && typeof betterTableModule.insertTable === 'function') {
                betterTableModule.insertTable(3, 3);
              } else {
                quill.clipboard.dangerouslyPasteHTML(index, tableHtml);
              }
            } catch (err) {
              console.error('Insert table failed', err);
            }
          });
        }
      } catch (e) {
        console.warn('Table init failed', e);
      }
    }, 200);

    // Update preview on text change
    quill.on('text-change', function() {
      document.getElementById('preview').innerHTML = quill.root.innerHTML;
    });

    // Initialize with existing content if editing (safe JSON blob parsing)
    (function restoreExistingContent() {
      try {
        var el = document.getElementById('existingContent');
        if (el && el.textContent) {
          try {
            var existingContent = JSON.parse(el.textContent);
            if (existingContent) {
              quill.clipboard.dangerouslyPasteHTML(existingContent);
              var prev = document.getElementById('preview');
              if (prev) prev.innerHTML = existingContent;
            }
          } catch (e) { console.warn('failed to parse existingContent JSON', e); }
        }
      } catch(e) { console.warn('failed to restore existing content', e); }
    })();

    // ---------------------- Quiz Builder Logic ----------------------
    // quiz data structure: { settings: { timeLimit, shuffle }, questions: [ { type, prompt, choices, correct } ] }
    var quizData = { settings: { timeLimit: 0, shuffle: false }, questions: [] };


    function renderQuizBuilder() {
      var container = document.getElementById('quizBuilder');
      if (!container) return;
      if (!quizData || !Array.isArray(quizData.questions) || quizData.questions.length === 0) {
        container.innerHTML = '<div class="alert alert-secondary">No questions yet. Click "Add Question" to start building the quiz.</div>';
        return;
      }
      var out = [];
      quizData.questions.forEach(function(q, idx){
        out.push('<div class="card mb-3">');
        out.push('<div class="card-body">');
        out.push('<div class="d-flex justify-content-between align-items-start mb-2">');
        out.push('<h6 class="mb-0">Question '+(idx+1)+'</h6>');
        out.push('<div>');
        out.push('<button type="button" class="btn btn-sm btn-outline-danger me-1" onclick="removeQuestion('+idx+')"><i class="bi bi-trash"></i></button>');
        out.push('</div>');
        out.push('</div>');

        out.push('<div class="mb-2">');
        out.push('<label class="form-label">Prompt</label>');
        out.push('<textarea class="form-control form-control-sm" rows="2" onchange="updatePrompt('+idx+', this.value)">'+(q.prompt?escapeHtml(q.prompt):'')+'</textarea>');
        out.push('</div>');

        out.push('<div class="row g-2 align-items-center mb-2">');
        out.push('<div class="col-auto">');
        out.push('<label class="form-label">Type</label>');
        out.push('<select class="form-select form-select-sm" onchange="changeType('+idx+', this.value)">');
        out.push('<option value="mcq"'+(q.type==='mcq'?' selected':'')+'>Multiple Choice</option>');
        out.push('<option value="short"'+(q.type==='short'?' selected':'')+'>Short Answer</option>');
        out.push('<option value="long"'+(q.type==='long'?' selected':'')+'>Long Answer</option>');
        out.push('</select>');
        out.push('</div>');
        out.push('</div>');

        // choices for MCQ
        if (q.type === 'mcq') {
          out.push('<div class="mb-2">');
          out.push('<label class="form-label">Choices</label>');
          q.choices.forEach(function(choice, cidx){
            out.push('<div class="input-group input-group-sm mb-1">');
            out.push('<span class="input-group-text">');
            out.push('<input class="form-check-input mt-0" type="radio" name="correct_'+idx+'" '+(q.correct===cidx?'checked':'')+' onchange="setCorrect('+idx+','+cidx+')">');
            out.push('</span>');
            out.push('<input type="text" class="form-control form-control-sm" value="'+escapeHtml(choice)+'" onchange="updateChoice('+idx+','+cidx+', this.value)">');
            out.push('<button class="btn btn-outline-secondary" type="button" onclick="removeChoice('+idx+','+cidx+')"><i class="bi bi-x"></i></button>');
            out.push('</div>');
          });
          out.push('<div class="d-flex gap-2">');
          out.push('<button class="btn btn-sm btn-outline-primary" type="button" onclick="addChoice('+idx+')"><i class="bi bi-plus"></i> Add Choice</button>');
          out.push('</div>');
          out.push('</div>');
        }

        out.push('</div>');
        out.push('</div>');
      });
      container.innerHTML = out.join('\n');
    }

    function addQuestion() {
      if (!quizData || typeof quizData !== 'object') quizData = { settings: { timeLimit: 0, shuffle: false }, questions: [] };
      if (!Array.isArray(quizData.questions)) quizData.questions = [];
      quizData.questions.push({ type: 'mcq', prompt: '', choices: ['Option 1','Option 2','Option 3','Option 4'], correct: 0 });
      renderQuizBuilder();
    }

    function removeQuestion(i) {
      quizData.questions.splice(i,1);
      renderQuizBuilder();
    }

    function updatePrompt(i, v) { quizData.questions[i].prompt = v; }
    function changeType(i, v) { quizData.questions[i].type = v; if (v !== 'mcq') { quizData.questions[i].choices = []; quizData.questions[i].correct = null; } else if (!quizData.questions[i].choices || quizData.questions[i].choices.length===0) { quizData.questions[i].choices = ['Option 1','Option 2']; quizData.questions[i].correct = 0; } renderQuizBuilder(); }
    function addChoice(i) { quizData.questions[i].choices.push('New choice'); renderQuizBuilder(); }
    function removeChoice(i,c) { quizData.questions[i].choices.splice(c,1); if (quizData.questions[i].correct===c) quizData.questions[i].correct = 0; renderQuizBuilder(); }
    function updateChoice(i,c,v) { quizData.questions[i].choices[c] = v; }
    function setCorrect(i,c) { quizData.questions[i].correct = c; }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g, '&#39;');
    }

    // Load existing quiz if present using a safe JSON blob inserted by the server
    (function loadExistingQuiz() {
      try {
        var el = document.getElementById('existingQuiz');
        if (el && el.textContent) {
          try {
            var existingQuiz = JSON.parse(el.textContent);
            // existingQuiz might itself be a JSON string stored in DB
            if (typeof existingQuiz === 'string') {
              try { existingQuiz = JSON.parse(existingQuiz); } catch (e) { /* keep as string */ }
            }
            if (existingQuiz && typeof existingQuiz === 'object') {
              quizData = existingQuiz;
            }
          } catch (innerErr) { console.warn('existingQuiz parse failed', innerErr); }
        }
      } catch (e) {
        console.warn('Could not load existing quiz', e);
      }

      // Ensure quizData has expected structure
      if (!quizData || typeof quizData !== 'object') quizData = { settings: { timeLimit: 0, shuffle: false }, questions: [] };
      if (!Array.isArray(quizData.questions)) quizData.questions = [];
      if (!quizData.settings || typeof quizData.settings !== 'object') quizData.settings = { timeLimit: 0, shuffle: false };
    })();

    // DOM initialization - attach handlers and sync UI after elements exist
    document.addEventListener('DOMContentLoaded', function() {
      // Attach add/clear buttons
      var addBtn = document.getElementById('btnAddQuestion');
      if (addBtn) addBtn.addEventListener('click', function(){ addQuestion(); });

      var clearBtn = document.getElementById('btnClearQuiz');
      if (clearBtn) clearBtn.addEventListener('click', function(){
        if (confirm('Clear all quiz questions?')) { quizData.questions = []; renderQuizBuilder(); }
      });

      // Update settings UI from quizData
      var timeLimitEl = document.getElementById('quizTimeLimit');
      var shuffleEl = document.getElementById('quizShuffle');
      if (timeLimitEl) timeLimitEl.value = quizData.settings && quizData.settings.timeLimit ? quizData.settings.timeLimit : '';
      if (shuffleEl) shuffleEl.checked = quizData.settings && quizData.settings.shuffle ? true : false;

      // Render builder
      try { renderQuizBuilder(); } catch (e) { console.warn('renderQuizBuilder failed:', e); }

      // Before submitting the form, serialize quiz builder state
      function syncQuizToHidden() {
        // sync settings
        var t = Number((document.getElementById('quizTimeLimit') && document.getElementById('quizTimeLimit').value) || 0) || 0;
        var s = (document.getElementById('quizShuffle') && document.getElementById('quizShuffle').checked) ? true : false;
        quizData.settings = { timeLimit: t, shuffle: s };
        var quizInput = document.getElementById('quiz');
        if (quizInput) quizInput.value = JSON.stringify(quizData);
      }

      // On form submit, copy editor content to hidden input and sync quiz
      var formEl = document.getElementById('reviewerForm');
      if (formEl) {
        formEl.addEventListener('submit', function(e) {
          e.preventDefault(); // Prevent default submission first

          var content = quill.root.innerHTML;

          // Don't submit if empty
          if (quill.getText().trim().length === 0) {
            alert('Please add some content to the reviewer!');
            return false;
          }

          // Set the hidden input value
          var contentInput = document.getElementById('content');
          if (contentInput) contentInput.value = content;

          // Sync quiz builder into hidden input
          try { syncQuizToHidden(); } catch (err) { console.warn('Could not sync quiz:', err); }

          // Now submit the form
          e.target.submit();
        });
      }
    });

    // Add keyboard shortcut hint
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸ’¡ Pro tip: Use Ctrl+B for bold, Ctrl+I for italic, Ctrl+U for underline');
    });
  </script>
</body>
</html>
