<%- include('partials/header') -%>
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1><%= reviewer.title %></h1>
      <div class="text-muted">Posted <%= new Date(reviewer.created_at).toLocaleString() %></div>
    </div>
    <div>
      <a href="/subject/<%= reviewer.subject_id %>" class="btn btn-secondary">Back</a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <div id="content"> <%- reviewer.content_html %> </div>
    </div>
  </div>

  <div>
    <button id="genQuiz" class="btn btn-primary">Generate Quiz</button>
  </div>

  <div id="quizArea" class="mt-4"></div>
</div>

<script>
  document.getElementById('genQuiz').addEventListener('click', async () => {
    const res = await fetch(`/reviewer/<%= reviewer.id %>/quiz`);
    const payload = await res.json();
    const qa = payload.questions || [];
    const area = document.getElementById('quizArea');
    area.innerHTML = '';
    if (!qa.length) { area.innerHTML = '<p class="text-muted">Not enough content to generate a quiz.</p>'; return; }
    const form = document.createElement('form');
    form.onsubmit = (e) => { e.preventDefault(); checkAnswers(qa); };
    qa.forEach((q, idx) => {
      const div = document.createElement('div');
      div.className = 'mb-3';
      const p = document.createElement('p');
      p.innerHTML = `<strong>Q${idx+1}.</strong> ${q.prompt}`;
      const input = document.createElement('input');
      input.className = 'form-control';
      input.setAttribute('data-ans', q.answer || '');
      div.appendChild(p);
      div.appendChild(input);
      form.appendChild(div);
    });
    const btn = document.createElement('button');
    btn.className = 'btn btn-success';
    btn.textContent = 'Check Answers';
    form.appendChild(btn);
    area.appendChild(form);
  });

  function checkAnswers(qa) {
    const inputs = document.querySelectorAll('#quizArea input');
    let correct = 0;
    inputs.forEach((inp, i) => {
      const ans = inp.getAttribute('data-ans').toLowerCase().trim();
      const val = inp.value.toLowerCase().trim().replace(/[^a-z']/g,'');
      const ok = ans && val === ans.toLowerCase();
      inp.classList.remove('is-valid','is-invalid');
      inp.classList.add(ok ? 'is-valid' : 'is-invalid');
      if (ok) correct++;
    });
    const out = document.createElement('div');
    out.className = 'mt-3';
    out.innerHTML = `<div class="alert alert-info">Score: ${correct} / ${inputs.length}</div>`;
    const area = document.getElementById('quizArea');
    area.appendChild(out);
  }
</script>

<%- include('partials/footer') -%>
